# nmrfp

## Overview
This repository contains software and an augmented NMR spectra dataset for training and applying a Deep Set Model (DSM) for NMR fingerprinting of mixtures. 
Details are provided in the associated [paper](https://doi.org/...).

---

## Repository Structure
```text
nmrfp/
│
├── Application/
│   ├── functions/
│   │   └── constants.py
│   ├── input/
│   │   ├── Blanc.xlsx
│   │   ├── Mixture_I.xlsx
│   │   ├── Mixture_II.xlsx
│   │   ├── Mixture_III.xlsx
│   │   └── Mixture_IV.xlsx
│   ├── output/
│   └── fingerprinting.py
│
├── Model/
│   ├── layers/
│   │   ├── __init__.py
│   │   └── equivariant.py
│   ├── parameters/
│   │   └── DSM_final.pt
│   └── dsm.py
│
├── Production/
│   ├── data/
│   │   ├── data.csv
│   │   └── data.json
│   ├── functions/
│   │   ├── reproducibility.py
│   │   └── routines.py
│   ├── save/
│   ├── sets/
│   ├── prepare.py
│   └── produce.py
│
└── requirements.txt
```
---

## Installation
```bash
git clone <repository-url>
cd nmrfp
pip install -r requirements.txt
```
---

## Usage
Scripts in the Production directory prepare the augmented dataset and train the Deep Set Model.
Scripts in the Application directory apply the trained model to perform NMR fingerprinting of mixtures.

All commands below must be executed from the repository root directory (`nmrfp/`).

```bash
# Prepare data
python -m Production/prepare

# Train model
python -m Production/produce

# Apply model to mixtures
python -m Application/fingerprinting
```

The DSM parameters generated by the training script (`Production/produce.py`) are saved in the `Production/save/` directory.  
These can be used for application by replacing the existing parameter file in `Model/parameters/`.

---

## File Descriptions
### Production
```text
data/                  
  ├── data.csv         Tabular dataset  
  └── data.json        JSON version of the dataset  

prepare.py             Prepares data for model training  
sets/                  Stores prepared training and validation sets  
produce.py             Trains the DSM using prepared sets  
save/                  Stores trained model parameters and training logs  

functions/
  ├── routines.py      Training and validation routines  
  └── reproducibility.py  Utilities for reproducible model training  
```
### Model
```text
dsm.py                 Defines the DSM architecture  

layers/
  ├── equivariant.py   Defines model layers  
  └── __init__.py      Initializes the layer module  

parameters/
  └── DSM_final.pt     Pretrained DSM parameters used in the paper  
```
### Application
```text
input/
  ├── Blanc.xlsx       Blank reference input  
  ├── Mixture_I.xlsx   Mixture data from the paper  
  ├── Mixture_II.xlsx  
  ├── Mixture_III.xlsx  
  └── Mixture_IV.xlsx  

fingerprinting.py      Applies DSM for NMR fingerprinting  
output/                Stores fingerprinting results  

functions/
  └── constants.py     Constants used in fingerprinting scripts  
```
---

## Explanation of Data Files
The files `data.csv` and `data.json` contain the augmented NMR dataset used for training and validation of the DSM.  
Each entry represents a molecular spectrum. When multiple spectra for the same compound were available under similar conditions, their corresponding values were averaged.

- `Name:` Molecule name as specified in the source data base  
- `SMILES:` SMILES string as specified in the source data base  
- `Solvent:` Solvent(s) used in the NMR measurement  
- `Temperature:` Temperature(s) of the NMR measurement(s)  
- `Source:` Origin of the data (`NMRshiftDB` or `BMRB`)  
- `LabelC:` Labels of <sup>13</sup>C nuclei  
- `ShiftC:` Chemical shifts of <sup>13</sup>C nuclei  
- `StdC:` Standard deviations of the <sup>13</sup>C chemical shifts  
- `DEPT:` Substitution degree of <sup>13</sup>C nuclei [0 = primary, 1 = secondary, 2 = tertiary, 3 = quaternary]
- `LabelH:` Labels of <sup>1</sup>H nuclei  
- `ShiftH:` Chemical shifts of <sup>1</sup>H nuclei  
- `StdH:` Standard deviations of the <sup>1</sup>H chemical shifts  
- `Connections:` Connection matrix of <sup>13</sup>C and <sup>1</sup>H nuclei, analogous to an HSQC spectrum  
- `Groups:` NMR fingerprinting groups assigned to <sup>13</sup>C nuclei (see Table 1 in the paper)  
- `SyntheticC:` Boolean indicating whether the <sup>13</sup>C chemical shifts include predicted data  
- `PredictedC:` Boolean list indicating which <sup>13</sup>C chemical shifts are predicted  
- `SyntheticH:` Boolean indicating whether the <sup>1</sup>H chemical shifts include predicted data  
- `PredictedH:` Boolean list indicating which <sup>1</sup>H chemical shifts are predicted 

---

## Explanation of Input Files
Each input Excel file contains rows describing the spectral information from the NMR analysis of the mixture used in the DSM-based NMR fingerprinting:

- `Chemical shifts 13C:` Chemical shift values of <sup>13</sup>C NMR signals  
- `Signal areas 13C:` Integrated areas of <sup>13</sup>C NMR signals  
- `Intensities DEPT 90:` Signal intensities in the <sup>13</sup>C DEPT 90 NMR spectrum [0 = no intensity or decreased intensity compared to <sup>13</sup>C NMR spectrum, + = increased intensity compared to <sup>13</sup>C NMR spectrum] 
- `Intensities DEPT 135:` Signal intensities in the <sup>13</sup>C DEPT 135 NMR spectrum [0 = no intensity or decreased intensity compared to <sup>13</sup>C NMR spectrum, + = increased intensity compared to <sup>13</sup>C NMR spectrum, - = negative signal intensity]  
- `Chemical shifts 1H:` Chemical shift values of <sup>1</sup>H nuclei showing HSQC cross signals  
- `HSQC connections:` Index number(s) of the <sup>13</sup>C NMR signals connected to the <sup>1</sup>H NMR signal specified above, numbered sequentially as in the file starting from 1  
- `Labile 1H:` Presence of labile protons as determined from the HSQC NMR spectrum  

---

## Requirements
All dependencies are listed in requirements.txt

---

## License
This project is licensed under the MIT License.

---

## Citation
If you use the NMR fingerprinting method or this software in scientific research, please cite the following papers:  
- ...
